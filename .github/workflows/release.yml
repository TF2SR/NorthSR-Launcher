name: Build
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write # Needed to write to GitHub draft release

env:
  RONIN_VERSION: ${{ github.ref_name }}

jobs:
  build-launcher:
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup msvc
        uses: ilammy/msvc-dev-cmd@v1
      - name: Configure cmake
        run: cmake -G "Ninja" -DCMAKE_BUILD_TYPE:STRING="Release"
      - name: Setup resource file version
        shell: bash
        run: |
          sed -i 's/DEV/${{ env.RONIN_VERSION }}/g' RoninLauncher/resources.rc
          FILEVERSION=$(echo ${{ env.RONIN_VERSION }} | tr '.' ',' | sed -E 's/-rc[0-9]+//' | tr -d '[:alpha:]')
          sed -i "s/0,0,0,1/${FILEVERSION}/g" RoninDLL/ns_version.h
      - name: Build
        run: cmake --build .
      - name: Upload launcher build as artifact
        uses: actions/upload-artifact@v3
        with:
          name: ronin-launcher
          path: |
            game/*.exe
            game/*.dll
      - name: Upload debug build artifact
        uses: actions/upload-artifact@v3
        with:
          name: launcher-debug-files
          path: |
            game/*.pdb
            game/bin/x64_retail/*.pdb

  upload-launcher-to-release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build-launcher
    runs-on: ubuntu-22.04
    steps:
      - name: Download compiled launcher
        uses: actions/download-artifact@v3
        with:
          name: ronin-launcher
          path: ronin-launcher
      - name: Download compiled launcher
        uses: actions/download-artifact@v3
        with:
          name: launcher-debug-files
          path: launcher-debug-files
      - name: Create zip with binaries
        run: |
          cd ronin-launcher
          zip --recurse-paths --quiet ../ronin-launcher.zip *
      - name: Create zip with debug symbols
        run: |
          cd launcher-debug-files
          zip --recurse-paths --quiet ../launcher-debug-files.zip *
      - name: Upload files to release
        uses: softprops/action-gh-release@v1
        with:
          body: ":warning: These are development files! If you want to download Ronin, [go here instead](https://github.com/TF2SR/Ronin/releases) :warning:"
          draft: false
          files: |
            ronin-launcher.zip
            launcher-debug-files.zip